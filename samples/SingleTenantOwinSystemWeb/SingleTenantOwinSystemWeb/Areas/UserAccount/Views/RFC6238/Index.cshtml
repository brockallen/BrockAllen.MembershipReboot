@using BrockAllen.MembershipReboot
@model SingleTenantOwinSystemWeb.Areas.UserAccount.Models.RFC6238Model

@{
    ViewBag.Title = "Configure Google / Microsoft Authenticator (RFC6238)";
}

<h2>Configure Google / Microsoft Authenticator (RFC6238)</h2>

@if (Model.Account.AuthenticatorSecret == null)
{
    <p>
        Google/Microsoft authentication is inactive for your account.
    </p>
    <p>
        Protect your account with an extra layer of security by requiring access to your phone. Once configured, you'll be required to enter a code created by the Google Authenticator, Duo Mobile, Authy, or Windows Phone Authenticator apps in order to sign into your account.
    </p>

    <a href="@Url.Action("Activate")" class="btn btn-success btn-lg">Configure Authenticator</a>

}
else if (Model.Account.AuthenticatorSecret != null && !Model.Account.AuthenticatorActive)
{
    <section class="tab_pane selected clearfix" data-tab="settings">

        <div class="row">
            <div class="col col-md-2">
                <p class="align_center">
                </p>
            </div>
            <div class="col col-md-10">
                <h4>Step 1</h4>
                <p class="small_bottom_margin"><b>Get the App</b></p>
                <p>Download and install the <a href="https://m.google.com/authenticator" target="_blank">Google Authenticator</a>, <a href="http://guide.duosecurity.com/third-party-accounts" target="_blank">Duo Mobile</a>, <a href="https://www.authy.com/" target="_blank">Authy</a>, or <a href=" https://www.windowsphone.com/en-us/store/app/authenticator/e7994dbc-2336-4950-91ba-ca22d653759b">Windows Phone Authenticator</a> app for your phone or tablet.</p>
            </div>

            <hr>

        </div>

        <div class="row">

            <div class="col col-md-2">
                <p class="align_center">
                    <div id="qrcode"></div>
                </p>
            </div>

            <div class="col col-md-10">
                <h4>Step 2</h4>
                <p><b>Scan this Barcode</b></p>
                <p class="small_bottom_margin">Open the authentication app and:</p>
                <ul>
                    <li>Tap the "+" icon in the top-right of the app</li>
                    <li>Scan the image to the left, using your phone's camera</li>
                </ul>

                <p class="small small_bottom_margin">(<a href="#" onclick="$('#init_key').toggleClass('hidden'); return false;">Can't scan this barcode?</a>)</p>
                <div id="init_key" class="hidden">
                    <p class="small small_bottom_margin">Instead of scanning, use your authentication app's "Manual entry" or equivalent option and provide the following time-based key. (Lower-case letters will work, too.)</p>
                    <code id="init_key_code" class="init_2fa_key">@Model.Account.AuthenticatorSecret</code>
                    <p class="small small_top_margin">Your app will then generate a 6-digit verification code, which you use below.</p>
                </div>


            </div>

            <hr>

        </div>

        <div class="row">

            <div class="col col-md-2">
                <p class="align_center">
                    <span class="configure-step3"></span>
                </p>
            </div>

            <div class="col col-md-10">
                <h4>Step 3</h4>
                <p class="small_bottom_margin"><b>Enter Verification Code</b></p>
                <p>Once the barcode above is scanned, enter the 6-digit verification code generated by the app.</p>

                <form action="@Url.Action("Activate")" method="post" accept-encoding="UTF-8" class="form-inline">
                    @Html.AntiForgeryToken()
                    <input type="text" id="two_factor_key" name="two_factor_key" placeholder="Code" autocomplete="off" class="form-control col-md-2">
                    <button id="two_factor_submit" type="submit" class="btn btn-default " data-style="expand-right"><span class="ladda-label">Verify Code and Activate</span></button>
                </form>
            </div>

            <hr>

        </div>

    </section>
    @section Scripts
    {
        <script type="text/javascript" src="@Url.Content("~/Scripts/qrcode.min.js")"></script>
        <script type="text/javascript">
            function get_url() {
                var url_obj = {};
                url_obj.label = escape("Membership Reboot");
                url_obj.user = escape("@Model.Account.Email");
                url_obj.key = "@Model.Account.AuthenticatorSecret";
                return "otpauth://totp/" + url_obj.label + ":" + url_obj.user + "?secret=" + url_obj.key + "&issuer=" + url_obj.label;
            }
            var qrcode = new QRCode("qrcode", {
                width: 128,
                height: 128,
            });
            qrcode.makeCode(get_url());
        </script>

    }
}
else if (Model.Account.AuthenticatorActive) {
    <div class="panel panel-success">
        <div class="panel-heading">
            Result
        </div>
        <div class="panel-body">
            Authenticator has been configured
        </div>
    </div>
    <a href="@Url.Action("Activate")" class="btn btn-info">Reset authenticator</a>
}